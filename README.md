﻿﻿# zigbee-zstack

## 目录

```javascript

.
├── Projects/zstack          		          # 用户自定义
│     ├── Samples/ZigbeeZstack/Source	    # 源代码       
│     │   └── App				              # Zstack协议(应用层)
│     │      ├── Lock			           # 门锁应用	
│     |      |   ├── Drivers                # 门锁驱动层
│     |      |   ├── Devices                # 门锁设备层
│     |      |   ├── AppsL                  # 门锁应用低层
│     |      |   └── AppsH                  # 门锁引用高层
│     │      └── Base			           # 基站应用 
│     ├── Tools				                # 配置文件
│     └── ZMain				                # 启动程序   
└── Components				              # Ti公司定义
      ├── hal             			      # 硬件驱动
      ├── mac          			          # MAC层
      ├── mt          			          # 串口通信
      ├── osal           			          # 操作系统
      ├── services            		      # 地址处理
      ├── stack               		      # Zstack协议(网络层、AF射频、ZDO等)
      └── zmac				              # MAC层
```


## 硬件配置

| 端口或定时器         	|     普通IO口或外设  | 方向 	       |     说明      |   Z-Stack	                                            |
| :--------              	| :--------             |:--------     |:--------      |:--------      						    |
| P1_5               	|  GPIO                 |  输出	       | LED   	       |   修改了LED配置，默认三个LED，都配置成P1_5 		    |
| P2_0               	|  GPIO                 | 上拉输出     | 蜂鸣器引脚    |   在Z-Stack中默认是摇杆按键，这里配置修改 		    |
| P0_1               	|  GPIO                 | 上拉输入     | 钥匙开门      |   修改了BUTTON配置，默认轮询扫描按键，配置成下降沿触发中断 |
| P0_4               	|  GPIO                 | 上拉输入     | 锁扣          |   修改了BUTTON配置，默认轮询扫描按键，配置成下降沿触发中断 |
| P0_5               	|  GPIO                 | 上拉输入     | 反锁          |   - |
| P0_6、P0_7、P1_0、P1_1 	|  GPIO                 | 输出或输入   | 电机H桥       |   -                                                        |
| P1_2、P1_3             	|  GPIO                 | 输出或输入   | EEPROM、时钟  |   - 							    |
| P1_2、P1_3、P0_2、P0_3、P1_7  |  GPIO                 | 输出或输入   | RFID读卡器    |   这里有端口和串口的外设端口冲突，覆盖了Z-Stack串口配置    |
| T4定时器                   |  外设                 | 输出         | 蜂鸣器引脚    |   覆盖了默认的Z-Stack定时器配置                            |

## 问题
| 问题类型          |     说明 | 
| :--------             | :--------|
| Flash             |  Z-Stack配置的spi_flash.c经常阻塞程序运行等待什么东西，HalFlashWriteTrigger()被我注释。 |
| EEPROM            |  EEPROM在存储和读取数据的时，需要注意在Z-Stack中不能存储后立马读取，需要一定的延时，具体原因未知。追加：进行for循环轮询读取连续地址的数据或写入连续地址的数据时候要在每一条操作后面跟一个5ms的延时! |
| RFID              |  需要注意在Z-Stack里有些端口被用作外设功能，如果要覆盖掉Z-Stack的配置，应该将端口用作普通IO或者外设功能的端口设置一下，这里模拟SPI时序一直出不来，就是因为有端口被用作外设而不是普通IO口，所以一直出问题，对于问题，可以先裸机跑，然后用排除法看是哪里出了问题。 |


## 进度记录

| 日期      |     进度 |
| :-------- | :--------|
| 2016/12/13    |  Z-Stack工程的建立，加入了基站和门锁的应用层程序。 |
| 2016/12/14    |  门锁低功耗模式，设计为PM2功耗模式,采用休眠-唤醒-休眠的工作模式。每1s向基站发送data request，获取基站的命令数据。 |
| 2016/12/15    |  设置门锁离线定时程序，每隔1s启动离线程序，修改了LED底层驱动，目前只是实现了LED 1s闪烁，后期需要加入RFID读卡程序。 |
| 2016/12/16    |  修改底层按键硬件驱动，测试了按键的轮询扫描模式和中断触发模式成功，最后使用中断模式，轮询扫描模式每隔100ms扫描按键有无按下，效率低反应慢。 |
| 2016/12/17    |  添加了延时函数和蜂鸣器应用。 |
| 2016/12/18    |  添加了i2c驱动程序，添加了电机端口驱动程序，添加了电机设备程序，添加了EEPROM存储和读取程序，可以做到开门电机正反转和蜂鸣器LED提示音效果，配置了锁扣的中断触发初始化程序，可以做到检测开门动作并及时关门处理。 |
| 2016/12/19    |  添加了门锁反锁识别，添加了RFID刷卡读写卡程序，可以利用RFID卡开门。 |
